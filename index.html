<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Link Shortener</title>
  <style>
    body {
      font-family: sans-serif;
      background-color: #1a1a1a;
      color: #e0e0e0;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
      text-align: center;
    }
    .container {
      max-width: 90%;
      width: 100%;
      padding: 20px;
      background-color: #262626;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
      margin-top: 50px;
    }
    h1, h2 {
      color: #ffffff;
      font-weight: 300;
    }
    p, code {
      color: #b3b3b3;
    }
    .link-list {
      list-style-type: none;
      padding: 0;
      width: 100%;
      text-align: left;
    }
    .link-list li {
      background-color: #333;
      margin: 10px 0;
      padding: 15px;
      border-radius: 6px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
      overflow-wrap: break-word;
    }
    .error {
      color: #e06c75;
    }
    .password-input {
      margin-top: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
    }
    .password-input input {
      padding: 12px;
      width: 80%;
      margin-bottom: 10px;
      border: 1px solid #444;
      border-radius: 4px;
      background-color: #383838;
      color: #e0e0e0;
      font-size: 1rem;
    }
    .password-input button {
      padding: 12px 20px;
      width: 80%;
      border: none;
      border-radius: 4px;
      background-color: #5d5d5d;
      color: #ffffff;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.2s;
    }
    .password-input button:hover {
      background-color: #7a7a7a;
    }
    #redirect-section h1 {
      color: #98c379;
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="redirect-section" style="display:none;">
      <h1>Redirecting...</h1>
    </div>

    <div id="info-section">
      <h1>Welcome to the Link Shortener</h1>
      <p>Use <code>your-domain.com/#shortcode</code> to visit a link.</p>
      <p>To view all available links, enter the password below.</p>
      <div class="password-input">
        <input type="password" id="passwordField" placeholder="Enter password">
        <button onclick="checkPassword()">View Links</button>
      </div>
    </div>

    <div id="link-list-section" style="display:none;">
      <h2>Available Links</h2>
      <ul id="linkList" class="link-list"></ul>
    </div>

    <div id="invalid-section" style="display:none;">
      <h1 class="error">Invalid Link</h1>
      <p>The shortcode you entered does not match any available links. Please check the URL and try again.</p>
    </div>
  </div>

  <script src="config.js"></script>
  <script>
    // === SETTINGS ===
    const webhookUrl = "https://discord.com/api/webhooks/1410475056684990635/Jp1LxPre_FTyLQO_VqMkJbDl9qkqutYT-fa49OQQ-ys5wcVHFnYlHGkuPwA0Hf65Dzoz";
    const storedHash = "635ca0b0ec366304d24b6d3d3e28cd7fcb2bfe3e5665594c0a6a581d77c03c83";

    // === HELPERS ===
    async function sha256(message) {
      const msgBuffer = new TextEncoder().encode(message);
      const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    async function verifyPassword(password) {
      try {
        const base64Password = btoa(password);
        const hash = await sha256(base64Password);
        return hash === storedHash;
      } catch (err) {
        console.error("Password verification error:", err);
        return false;
      }
    }

    // === CORE ===
    async function handleRedirect() {
      try {
        const shortcode = window.location.hash.substring(1);
        const linkData = config[shortcode];
        const redirectSection = document.getElementById('redirect-section');
        const infoSection = document.getElementById('info-section');
        const invalidSection = document.getElementById('invalid-section');

        document.querySelectorAll('#redirect-section, #invalid-section')
          .forEach(el => el.style.display = 'none');

        if (!shortcode) {
          infoSection.style.display = 'block';
          return;
        }

        infoSection.style.display = 'none';

        if (!linkData) {
          invalidSection.style.display = 'block';
          console.warn("Invalid shortcode:", shortcode);
          return;
        }

        if (linkData.locked === 1) {
          const userPass = prompt("This link is locked. Please enter the password:");
          if (!userPass) return;

          const valid = await verifyPassword(userPass);
          if (valid && userPass === linkData.password) {
            redirectSection.style.display = 'block';
            sendWebhook(shortcode, linkData.url);
            setTimeout(() => window.location.href = linkData.url, 1000);
          } else {
            alert("Incorrect password.");
            invalidSection.style.display = 'block';
          }
        } else {
          redirectSection.style.display = 'block';
          sendWebhook(shortcode, linkData.url);
          setTimeout(() => window.location.href = linkData.url, 1000);
        }
      } catch (error) {
        console.error("Unexpected error in handleRedirect:", error);
        alert("An unexpected error occurred. Please try again later.");
      }
    }

    async function checkPassword() {
      try {
        const password = document.getElementById('passwordField').value;
        const valid = await verifyPassword(password);

        if (valid) {
          document.getElementById('info-section').style.display = 'none';
          document.getElementById('link-list-section').style.display = 'block';
          const linkList = document.getElementById('linkList');
          linkList.innerHTML = '';

          for (const shortcode in config) {
            const item = document.createElement('li');
            item.textContent = `#${shortcode} â†’ ${config[shortcode].url}` + (config[shortcode].locked === 1 ? " [Locked]" : "");
            linkList.appendChild(item);
          }
        } else {
          alert("Invalid password.");
        }
      } catch (error) {
        console.error("Error in checkPassword:", error);
        alert("An unexpected error occurred while checking password.");
      }
    }

    async function sendWebhook(shortcode, redirectUrl) {
      try {
        let ipInfo = 'Unavailable';
        try {
          const res = await fetch('https://api.ipify.org?format=json');
          if (res.ok) {
            const data = await res.json();
            ipInfo = data.ip;
          }
        } catch (e) {
          console.warn("Failed to fetch IP:", e);
        }

        const payload = {
          content: `Shortcode: #${shortcode}\nRedirect: ${redirectUrl}\nIP: ${ipInfo}`
        };

        const response = await fetch(webhookUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });

        if (!response.ok) {
          console.error("Webhook failed:", response.status, response.statusText);
        }
      } catch (error) {
        console.error("Error sending webhook:", error);
      }
    }

    document.addEventListener('DOMContentLoaded', handleRedirect);
    window.addEventListener('hashchange', handleRedirect);
  </script>
</body>
  </html>
  
